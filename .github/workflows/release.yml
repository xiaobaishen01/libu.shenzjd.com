name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build
        env:
          VITE_TELEMETRY_DISABLED: '1'

      - name: Create release package
        run: |
          # åˆ›å»ºæ‰“åŒ…ç›®å½•
          mkdir -p release-package

          # å¤åˆ¶æ„å»ºäº§ç‰©ï¼ˆå•æ–‡ä»¶ï¼‰
          echo "ğŸ“¦ å¤åˆ¶æ„å»ºæ–‡ä»¶..."
          cp dist/index.html release-package/

          # å¤åˆ¶ README
          echo "ğŸ“ å¤åˆ¶è¯´æ˜æ–‡ä»¶..."
          cp README.md release-package/

          # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
          TAG_NAME="${{ github.ref_name || inputs.tag_name }}"
          cat > release-package/VERSION.txt << EOF
          ç¤¼ç°¿ç³»ç»Ÿç‰ˆæœ¬: $TAG_NAME
          æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          ä»“åº“: ${{ github.repository }}
          æ„å»ºè€…: ${{ github.actor }}
          EOF

          # å‹ç¼©æ‰“åŒ…
          echo "ğŸ—œï¸ å‹ç¼©æ‰“åŒ…ä¸­..."
          tar -czf release-package.tar.gz -C release-package .

          # æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          echo "âœ… æ‰“åŒ…å®Œæˆ: release-package.tar.gz"
          ls -lh release-package.tar.gz
          echo "ğŸ“¦ åŒ…å«å†…å®¹:"
          tar -tzf release-package.tar.gz

      - name: Get or Create Tag
        id: get_tag
        run: |
          TAG_NAME="${{ github.ref_name || inputs.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            # å¦‚æœæ²¡æœ‰ tagï¼Œä½¿ç”¨æ—¥æœŸå’Œæ—¶é—´ç”Ÿæˆ
            TAG_NAME="v$(date +%Y%m%d-%H%M%S)"
            echo "åˆ›å»ºæ–° tag: $TAG_NAME"
            git tag $TAG_NAME
            git push origin $TAG_NAME
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: Release ${{ steps.get_tag.outputs.tag_name }}
          body: |
            ## ğŸ‰ ç¤¼ç°¿ç³»ç»Ÿ ${{ steps.get_tag.outputs.tag_name }}

            ### âœ¨ æ ¸å¿ƒç‰¹æ€§
            - âœ… **å•æ–‡ä»¶åº”ç”¨**ï¼šæ‰€æœ‰ä»£ç å†…è”åˆ°å•ä¸ª HTML æ–‡ä»¶ï¼ˆ298KBï¼‰
            - âœ… **æ— éœ€æœåŠ¡å™¨**ï¼šæ”¯æŒ file:// åè®®ï¼ŒåŒå‡»å³å¯ä½¿ç”¨
            - âœ… **æ•°æ®åŠ å¯†**ï¼šAES-256 åŠ å¯† + SHA-256 å¯†ç å“ˆå¸Œ
            - âœ… **åŒå±è”åŠ¨**ï¼šå®æ—¶åŒæ­¥å‰¯å±å±•ç¤º

            ### ğŸ“¦ åŒ…å«å†…å®¹
            - `index.html` - å•æ–‡ä»¶åº”ç”¨ï¼ˆå¯ç›´æ¥æ‰“å¼€ï¼‰
            - `README.md` - ä½¿ç”¨è¯´æ˜
            - `VERSION.txt` - ç‰ˆæœ¬ä¿¡æ¯

            ### ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆæ— éœ€æœåŠ¡å™¨ï¼ï¼‰

            **æ–¹å¼1: ç›´æ¥æ‰“å¼€ï¼ˆæ¨èï¼‰**
            ```bash
            tar -xzf release-package.tar.gz
            cd release-package
            # åŒå‡» index.html æˆ– Ctrl+O åœ¨æµè§ˆå™¨æ‰“å¼€
            ```

            **æ–¹å¼2: æœ¬åœ°æœåŠ¡å™¨**
            ```bash
            cd release-package
            npx serve .
            # è®¿é—®: http://localhost:3000
            ```

            **æ–¹å¼3: éƒ¨ç½²åˆ°æœåŠ¡å™¨**
            ```bash
            # ä¸Šä¼  index.html åˆ° Web æœåŠ¡å™¨
            # æˆ–éƒ¨ç½²åˆ° GitHub Pages
            ```

            ### ğŸ“ æ„å»ºä¿¡æ¯
            - **Commit**: ${{ github.sha }}
            - **æ„å»ºè€…**: ${{ github.actor }}
            - **åˆ†æ”¯**: ${{ github.ref_name }}

            ### ğŸ¯ é¡µé¢è·¯ç”±
            - é¦–é¡µ: `index.html#/`
            - åˆ›å»ºäº‹ä»¶: `index.html#/setup`
            - ä¸»ç•Œé¢: `index.html#/main`
            - å‰¯å±: `index.html#/guest-screen`

            ### ğŸ”’ é»˜è®¤é…ç½®
            - é»˜è®¤å¯†ç : `123456`
            - æ•°æ®å­˜å‚¨: localStorage
            - åŠ å¯†æ–¹å¼: AES-256

          files: release-package.tar.gz
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Success
        run: |
          echo "ğŸ‰ Release å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ Tag: ${{ steps.get_tag.outputs.tag_name }}"
          echo "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag_name }}"
