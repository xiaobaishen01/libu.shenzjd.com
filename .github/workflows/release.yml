name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build
        env:
          VITE_TELEMETRY_DISABLED: '1'

      - name: Prepare release file
        run: |
          # å¤åˆ¶æ„å»ºäº§ç‰©
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
          cp dist/index.html ./
          echo "âœ… å‡†å¤‡å®Œæˆ: index.html"
          ls -lh index.html

      - name: Get or Create Tag
        id: get_tag
        run: |
          TAG_NAME="${{ github.ref_name || inputs.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            # å¦‚æœæ²¡æœ‰ tagï¼Œä½¿ç”¨æ—¥æœŸå’Œæ—¶é—´ç”Ÿæˆ
            TAG_NAME="v$(date +%Y%m%d-%H%M%S)"
            echo "åˆ›å»ºæ–° tag: $TAG_NAME"
            git tag $TAG_NAME
            git push origin $TAG_NAME
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: Release ${{ steps.get_tag.outputs.tag_name }}
          body: |
            ## ğŸ‰ ç¤¼ç°¿ç³»ç»Ÿ ${{ steps.get_tag.outputs.tag_name }}

            ### âœ¨ æ ¸å¿ƒç‰¹æ€§
            - âœ… **å•æ–‡ä»¶åº”ç”¨**ï¼šæ‰€æœ‰ä»£ç å†…è”åˆ°å•ä¸ª HTML æ–‡ä»¶ï¼ˆ298KBï¼‰
            - âœ… **æ— éœ€æœåŠ¡å™¨**ï¼šæ”¯æŒ file:// åè®®ï¼ŒåŒå‡»å³å¯ä½¿ç”¨
            - âœ… **æ•°æ®åŠ å¯†**ï¼šAES-256 åŠ å¯† + SHA-256 å¯†ç å“ˆå¸Œ
            - âœ… **åŒå±è”åŠ¨**ï¼šå®æ—¶åŒæ­¥å‰¯å±å±•ç¤º

            ### ğŸ“¦ åŒ…å«æ–‡ä»¶
            - `index.html` - å•æ–‡ä»¶åº”ç”¨ï¼ˆå¯ç›´æ¥æ‰“å¼€ï¼‰

            ### ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆæ— éœ€æœåŠ¡å™¨ï¼ï¼‰

            **æ–¹å¼1: ç›´æ¥æ‰“å¼€ï¼ˆæ¨èï¼‰**
            ```bash
            # ä¸‹è½½ index.html
            # åŒå‡»å³å¯ä½¿ç”¨ï¼
            ```

            **æ–¹å¼2: æœ¬åœ°æœåŠ¡å™¨**
            ```bash
            npx serve .
            # è®¿é—®: http://localhost:3000
            ```

            **æ–¹å¼3: éƒ¨ç½²åˆ°æœåŠ¡å™¨**
            ```bash
            # ä¸Šä¼  index.html åˆ° Web æœåŠ¡å™¨
            # æˆ–éƒ¨ç½²åˆ° GitHub Pages
            ```

            ### ğŸ¯ é¡µé¢è·¯ç”±
            - é¦–é¡µ: `index.html#/`
            - åˆ›å»ºäº‹ä»¶: `index.html#/setup`
            - ä¸»ç•Œé¢: `index.html#/main`
            - å‰¯å±: `index.html#/guest-screen`

            ### ğŸ”’ é»˜è®¤é…ç½®
            - é»˜è®¤å¯†ç : `123456`
            - æ•°æ®å­˜å‚¨: localStorage
            - åŠ å¯†æ–¹å¼: AES-256

          files: index.html
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Success
        run: |
          echo "ğŸ‰ Release å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ Tag: ${{ steps.get_tag.outputs.tag_name }}"
          echo "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag_name }}"
