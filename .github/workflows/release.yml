name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build
        env:
          VITE_TELEMETRY_DISABLED: '1'

      - name: Prepare release file
        run: |
          # å¤åˆ¶æ„å»ºäº§ç‰©
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
          cp dist/index.html ./
          echo "âœ… å‡†å¤‡å®Œæˆ: index.html"
          ls -lh index.html

      - name: Get or Create Tag
        id: get_tag
        run: |
          TAG_NAME="${{ github.ref_name || inputs.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            # å¦‚æœæ²¡æœ‰ tagï¼Œä½¿ç”¨æ—¥æœŸå’Œæ—¶é—´ç”Ÿæˆ
            TAG_NAME="v$(date +%Y%m%d-%H%M%S)"
            echo "åˆ›å»ºæ–° tag: $TAG_NAME"
            git tag $TAG_NAME
            git push origin $TAG_NAME
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: Release ${{ steps.get_tag.outputs.tag_name }}
          body: |
            ## ğŸ‰ ç¤¼ç°¿ç³»ç»Ÿ ${{ steps.get_tag.outputs.tag_name }}

            ### ğŸ“¦ æœ¬æ¬¡æ›´æ–°å†…å®¹

            **ğŸ¯ å‰¯å±è‡ªåŠ¨è½®æ’­ä¼˜åŒ–**
            - âœ… æ–°æ•°æ®å½•å…¥è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°è®°å½•
            - âœ… åœç•™10ç§’å±•ç¤ºæœ€æ–°æ•°æ®
            - âœ… è¶…æ—¶åå•å‘æ— é™è½®æ’­ï¼ˆä»å³å‘å·¦ï¼‰
            - âœ… æœ‰æ–°æ•°æ®ç«‹å³ä¸­æ–­è½®æ’­ï¼Œé‡æ–°å¼€å§‹

            **ğŸ¨ æ‰“å°åŠŸèƒ½ä¼˜åŒ–**
            - âœ… æ¨ªå±A4æ‰“å°ï¼Œå……åˆ†åˆ©ç”¨çº¸å¼ 
            - âœ… å…¨é‡æ‰“å°æ‰€æœ‰ç¤¼é‡‘è®°å½•
            - âœ… å½©è‰²ä¸»é¢˜é€‚é…ï¼ˆå–œäº‹çº¢/ä¸§äº‹ç°ï¼‰
            - âœ… ä¼ ç»Ÿç«–æ’æ ¼å¼

            **ğŸ’¾ æ•°æ®å¤‡ä»½ç³»ç»Ÿï¼ˆv1.0.1ï¼‰**
            - âœ… ä¸€é”®å¯¼å‡º/å¯¼å…¥å¤‡ä»½
            - âœ… æ™ºèƒ½åˆå¹¶ï¼Œè·³è¿‡é‡å¤
            - âœ… å¤šè®¾å¤‡åŒæ­¥æ”¯æŒ

            ### ğŸš€ å¿«é€Ÿå¼€å§‹

            1. ä¸‹è½½ `index.html`
            2. åŒå‡»æ‰“å¼€
            3. å¼€å§‹ä½¿ç”¨ï¼

            ### ğŸ”’ æ ¸å¿ƒç‰¹æ€§

            - âœ… **å•æ–‡ä»¶**ï¼šåªæœ‰ä¸€ä¸ª HTML æ–‡ä»¶
            - âœ… **ç¦»çº¿å¯ç”¨**ï¼šæ— éœ€æœåŠ¡å™¨ï¼Œæ”¯æŒ file:// åè®®
            - âœ… **æ•°æ®åŠ å¯†**ï¼šAES-256 åŠ å¯†å­˜å‚¨
            - âœ… **åŒå±è”åŠ¨**ï¼šå®æ—¶åŒæ­¥ï¼Œè‡ªåŠ¨è½®æ’­

            ### âš ï¸ é‡è¦æç¤º

            - æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°
            - å¿˜è®°å¯†ç æ— æ³•æ‰¾å›
            - åŠ¡å¿…å®šæœŸå¯¼å‡ºå¤‡ä»½ï¼

          files: index.html
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Success
        run: |
          echo "ğŸ‰ Release å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ Tag: ${{ steps.get_tag.outputs.tag_name }}"
          echo "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag_name }}"
