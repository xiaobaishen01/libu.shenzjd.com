name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm next build
        env:
          NEXT_PUBLIC_IS_EXPORT: 'true'

      - name: Create release package
        run: |
          # åˆ›å»ºæ‰“åŒ…ç›®å½•
          mkdir -p release-package

          # å¤åˆ¶æ„å»ºäº§ç‰©
          echo "ğŸ“¦ å¤åˆ¶æ„å»ºæ–‡ä»¶..."
          cp -r out release-package/

          # å¤åˆ¶é…ç½®æ–‡ä»¶
          echo "ğŸ“ å¤åˆ¶é…ç½®æ–‡ä»¶..."
          cp package.json release-package/ 2>/dev/null || true
          cp pnpm-lock.yaml release-package/ 2>/dev/null || true
          cp README.md release-package/ 2>/dev/null || true
          cp .env.example release-package/ 2>/dev/null || true

          # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
          TAG_NAME="${{ github.ref_name || inputs.tag_name }}"
          cat > release-package/VERSION.txt << EOF
          ç¤¼ç°¿ç³»ç»Ÿç‰ˆæœ¬: $TAG_NAME
          æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          ä»“åº“: ${{ github.repository }}
          æ„å»ºè€…: ${{ github.actor }}
          EOF

          # ç”Ÿæˆéƒ¨ç½²è¯´æ˜
          cat > release-package/README-éƒ¨ç½²è¯´æ˜.md << 'EOF'
          # ç¤¼ç°¿ç³»ç»Ÿ - éƒ¨ç½²è¯´æ˜

          ## ğŸ“¦ åŒ…å«å†…å®¹
          - `out/` - Next.js æ„å»ºå¥½çš„é™æ€æ–‡ä»¶
          - `package.json` - é¡¹ç›®é…ç½®
          - `README-éƒ¨ç½²è¯´æ˜.md` - æœ¬è¯´æ˜æ–‡ä»¶
          - `VERSION.txt` - ç‰ˆæœ¬ä¿¡æ¯

          ## ğŸš€ éƒ¨ç½²æ–¹æ³•

          ### æ–¹æ³•1: éƒ¨ç½²åˆ° GitHub Pages (æ¨è)
          1. è¿›å…¥ä»“åº“è®¾ç½® -> Pages
          2. é€‰æ‹© `gh-pages` åˆ†æ”¯æˆ– `out` ç›®å½•
          3. ä¿å­˜å¹¶ç­‰å¾…éƒ¨ç½²å®Œæˆ

          ### æ–¹æ³•2: éƒ¨ç½²åˆ° Vercel
          1. ç™»å½• [Vercel](https://vercel.com)
          2. å¯¼å…¥ä»“åº“
          3. è‡ªåŠ¨æ£€æµ‹ä¸º Next.js é¡¹ç›®
          4. éƒ¨ç½²

          ### æ–¹æ³•3: éƒ¨ç½²åˆ°å…¶ä»–é™æ€æ‰˜ç®¡
          1. å°† `out/` ç›®å½•å†…å®¹ä¸Šä¼ åˆ°ä½ çš„æœåŠ¡å™¨
          2. é…ç½® Web æœåŠ¡å™¨ï¼ˆNginx/Apacheï¼‰
          3. ç¡®ä¿æ”¯æŒ SPA è·¯ç”±é‡å†™

          ### æ–¹æ³•4: æœ¬åœ°è¿è¡Œ
          ```bash
          # å®‰è£…ä¾èµ–
          pnpm install

          # å¼€å‘æ¨¡å¼
          pnpm dev

          # ç”Ÿäº§æ¨¡å¼
          pnpm start
          ```

          ## ğŸ”§ é¦–æ¬¡ä½¿ç”¨é…ç½®

          1. è®¿é—® `/test-data` ç”Ÿæˆæµ‹è¯•æ•°æ®
          2. æˆ–è®¿é—® `/setup` åˆ›å»ºæ–°äº‹ä»¶
          3. é»˜è®¤å¯†ç : `123456`

          ## ğŸ“ å¸¸ç”¨å‘½ä»¤

          ```bash
          pnpm dev        # å¼€å‘æœåŠ¡å™¨
          pnpm build      # æ„å»º
          pnpm start      # ç”Ÿäº§è¿è¡Œ
          pnpm lint      # ä»£ç æ£€æŸ¥
          ```

          ## ğŸ”’ å®‰å…¨æç¤º

          - é¦–æ¬¡ä½¿ç”¨è¯·ä¿®æ”¹é»˜è®¤å¯†ç 
          - å®šæœŸå¤‡ä»½ localStorage æ•°æ®
          - ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½® GitHub åŒæ­¥

          ## ğŸ†˜ é—®é¢˜åé¦ˆ

          å¦‚é‡é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯æˆ–æäº¤ Issue
          EOF

          # å‹ç¼©æ‰“åŒ…
          echo "ğŸ—œï¸ å‹ç¼©æ‰“åŒ…ä¸­..."
          tar -czf release-package.tar.gz -C release-package .
          echo "âœ… æ‰“åŒ…å®Œæˆ: release-package.tar.gz"

      - name: Get or Create Tag
        id: get_tag
        run: |
          TAG_NAME="${{ github.ref_name || inputs.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            # å¦‚æœæ²¡æœ‰ tagï¼Œä½¿ç”¨æ—¥æœŸå’Œæ—¶é—´ç”Ÿæˆ
            TAG_NAME="v$(date +%Y%m%d-%H%M%S)"
            echo "åˆ›å»ºæ–° tag: $TAG_NAME"
            git tag $TAG_NAME
            git push origin $TAG_NAME
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: Release ${{ steps.get_tag.outputs.tag_name }}
          body: |
            ## ğŸ‰ ç¤¼ç°¿ç³»ç»Ÿ ${{ steps.get_tag.outputs.tag_name }}

            ### ğŸ“¦ åŒ…å«å†…å®¹
            - âœ… å®Œæ•´çš„æ„å»ºäº§ç‰© (out/)
            - âœ… æºä»£ç å’Œé…ç½®æ–‡ä»¶
            - âœ… è¯¦ç»†çš„éƒ¨ç½²è¯´æ˜

            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½ `release-package.tar.gz`
            2. è§£å‹åˆ°ç›®æ ‡ç›®å½•
            3. æŒ‰ç…§ `README-éƒ¨ç½²è¯´æ˜.md` æ“ä½œ

            ### ğŸ“ æ„å»ºä¿¡æ¯
            - **Commit**: ${{ github.sha }}
            - **æ„å»ºè€…**: ${{ github.actor }}
            - **åˆ†æ”¯**: ${{ github.ref_name }}

            ### ğŸ”§ ä½¿ç”¨æ–¹å¼

            **ç›´æ¥éƒ¨ç½² (æ¨è)**
            ```bash
            # è§£å‹åç›´æ¥å°† out ç›®å½•ä¸Šä¼ åˆ°æœåŠ¡å™¨
            # æˆ–éƒ¨ç½²åˆ° GitHub Pages / Vercel
            ```

            **æœ¬åœ°è¿è¡Œ**
            ```bash
            pnpm install
            pnpm dev
            ```

            **è®¿é—®åœ°å€**
            - é¦–é¡µ: `/`
            - æµ‹è¯•æ•°æ®: `/test-data`
            - äº‹ä»¶è®¾ç½®: `/setup`

            ### ğŸ“‹ é»˜è®¤é…ç½®
            - é»˜è®¤å¯†ç : `123456`
            - æ”¯æŒå¤šäº‹ä»¶ç®¡ç†
            - æ”¯æŒæ•°æ®åŠ å¯†å­˜å‚¨
            - æ”¯æŒå‰¯å±å±•ç¤º

          files: |
            release-package.tar.gz
            out/**/*.{html,css,js,json,txt}
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Success
        run: |
          echo "ğŸ‰ Release å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ Tag: ${{ steps.get_tag.outputs.tag_name }}"
          echo "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag_name }}"
